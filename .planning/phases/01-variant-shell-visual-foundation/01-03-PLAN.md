---
phase: 01-variant-shell-visual-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - public/map-styles/happy-light.json
  - public/map-styles/happy-dark.json
  - src/components/DeckGLMap.ts
  - src/styles/panels.css
  - src/styles/happy-theme.css
autonomous: false
requirements:
  - THEME-02
  - THEME-05

must_haves:
  truths:
    - "The map on the happy variant displays sage-colored landmass and light blue ocean in light mode"
    - "The map on the happy variant displays dark sage landmass and deep navy ocean in dark mode"
    - "DeckGLMap.ts selects happy basemap style URLs when SITE_VARIANT is 'happy'"
    - "Panel headers, empty states, and loading indicators render with warm rounded styling on the happy variant"
    - "Empty panels show a friendly 'Coming soon' message with nature-themed line illustration"
  artifacts:
    - path: "public/map-styles/happy-light.json"
      provides: "Modified CARTO Voyager style with sage land and light blue ocean"
      min_lines: 50
    - path: "public/map-styles/happy-dark.json"
      provides: "Modified dark basemap style with navy ocean and dark sage land"
      min_lines: 50
    - path: "src/components/DeckGLMap.ts"
      provides: "Variant-aware basemap style URL selection"
      contains: "happy"
  key_links:
    - from: "src/components/DeckGLMap.ts"
      to: "public/map-styles/happy-light.json"
      via: "MapLibre GL setStyle URL"
      pattern: "map-styles/happy-light"
    - from: "src/components/DeckGLMap.ts"
      to: "public/map-styles/happy-dark.json"
      via: "MapLibre GL setStyle URL"
      pattern: "map-styles/happy-dark"
    - from: "src/styles/happy-theme.css"
      to: "src/styles/panels.css"
      via: "CSS custom properties cascade"
      pattern: "--panel-radius"
---

<objective>
Create warm basemap styles for the map and update all UI chrome (panels, empty states, loading states) to render with the warm happy aesthetic.

Purpose: Complete the visual transformation by addressing the two most visible elements: the full-screen map and the panel chrome. The map needs custom style JSONs since MapLibre styles are not driven by CSS variables. Panel chrome needs targeted CSS updates for border-radius, empty states, and loading animations.

Output: Two self-hosted MapLibre style JSON files, variant-aware DeckGLMap basemap selection, and panel chrome CSS updates.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-variant-shell-visual-foundation/01-CONTEXT.md
@.planning/phases/01-variant-shell-visual-foundation/01-RESEARCH.md
@.planning/phases/01-variant-shell-visual-foundation/01-01-SUMMARY.md
@src/components/DeckGLMap.ts
@src/styles/panels.css
@src/styles/main.css
@src/styles/happy-theme.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create warm basemap style JSONs and wire into DeckGLMap</name>
  <files>
    public/map-styles/happy-light.json
    public/map-styles/happy-dark.json
    src/components/DeckGLMap.ts
  </files>
  <action>
    **1. Fetch and fork the CARTO Voyager style JSON** — The light basemap starts from CARTO Voyager (`https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json`).

    Steps:
    a. Fetch the Voyager style JSON from the CARTO CDN.
    b. Parse and modify only the `layers[].paint` properties. Keep ALL `sources`, `sprite`, `glyphs` URLs unchanged (they must remain absolute CARTO URLs — see Pitfall 3 in research).
    c. Modify these layer paint properties for `happy-light.json`:
       - `background` → `background-color: "#FAFAF5"` (cream, matches page bg)
       - `water` → `fill-color: "#D4E6EC"` (very light blue)
       - `waterway` → `line-color: "#C4D8E0"` (slightly darker blue for rivers)
       - `landcover` / `landuse` → `fill-color` shifted toward sage tones. Use muted sage greens like `"rgba(185, 205, 170, 0.3)"` for parks/forest, `"rgba(200, 210, 185, 0.2)"` for general landcover.
       - `boundary_country` / `boundary_state` → `line-color: "#C8C0B5"` (warm gray)
       - `road` layers → keep existing Voyager colors but slightly warm them (shift toward warmer grays)
       - `building` → keep subtle, warm tint if present
       - `place_label` / text layers → `text-color: "#4A5A4C"` (dark sage for labels), `text-halo-color: "#FAFAF5"` (cream halo)
    d. Save as `public/map-styles/happy-light.json`

    **2. Create the dark basemap** — Fork CARTO dark-matter (`https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json`).

    Modify for `happy-dark.json`:
    - `background` → `background-color: "#16202E"` (deep navy)
    - `water` → `fill-color: "#121C2A"` (very dark navy-blue)
    - `landcover` / `landuse` → dark sage tones `"rgba(45, 64, 53, 0.3)"`
    - `boundary` → `line-color: "#3D5045"` (dark sage-gray)
    - `road` → keep subtle, use navy-gray tones
    - `place_label` → `text-color: "#A0A098"` (warm dim text), `text-halo-color: "#1A2332"`
    - Keep ALL `sources`, `sprite`, `glyphs` URLs pointing to CARTO CDN.
    Save as `public/map-styles/happy-dark.json`

    **CRITICAL: Keep source/sprite/glyphs URLs unchanged.** Only modify `layers[].paint` and `layers[].layout` paint properties. If you change source URLs, the map will render blank.

    **3. Wire variant-aware basemap into DeckGLMap.ts** — Update the DARK_STYLE and LIGHT_STYLE constants at the top of the file (around line 139-140):

    ```typescript
    import { SITE_VARIANT } from '@/config/variant';

    const DARK_STYLE = SITE_VARIANT === 'happy'
      ? '/map-styles/happy-dark.json'
      : 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json';

    const LIGHT_STYLE = SITE_VARIANT === 'happy'
      ? '/map-styles/happy-light.json'
      : 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json';
    ```

    Check if `SITE_VARIANT` is already imported in DeckGLMap.ts. If not, add the import. If it's imported from `@/config` (barrel), that's fine too — just make sure the import resolves.

    The existing `switchBasemap()` method and initial style assignment both reference these constants, so no other changes needed in DeckGLMap.ts.

    **Note on the D3 SVG map (mobile):** The D3-based Map.ts reads `--map-bg`, `--map-country`, `--map-stroke`, `--map-grid` CSS variables via `getCSSColor()`. These are already overridden in happy-theme.css (Plan 02), so the mobile map will automatically render warm colors. No changes needed to Map.ts.
  </action>
  <verify>
    Run `ls -la public/map-styles/` to confirm both JSON files exist.
    Run `python3 -c "import json; j=json.load(open('public/map-styles/happy-light.json')); print(len(j.get('layers',[])), 'layers'); print('sources' in j)"` to confirm valid JSON with layers and sources.
    Run `grep 'happy.*map-styles\|SITE_VARIANT.*happy' src/components/DeckGLMap.ts` to confirm variant-aware style selection.
    Run `npx tsc --noEmit 2>&1 | head -10` to confirm no TypeScript errors.
  </verify>
  <done>
    - happy-light.json is a valid MapLibre style with sage land, cream background, light blue ocean
    - happy-dark.json is a valid MapLibre style with dark sage land, navy background, dark navy ocean
    - Both style JSONs preserve original CARTO source/sprite/glyph URLs
    - DeckGLMap.ts selects happy basemap URLs when SITE_VARIANT is 'happy'
    - switchBasemap() works correctly for happy variant (theme toggle changes map style)
  </done>
</task>

<task type="auto">
  <name>Task 2: Style panel chrome, empty states, and loading indicators for happy variant</name>
  <files>
    src/styles/happy-theme.css
    src/styles/panels.css
  </files>
  <action>
    **1. Panel border-radius** — The locked decision requires "generously rounded (12-16px radius)" panels. The existing panel CSS likely uses `border-radius: 0` or a small value.

    In `src/styles/happy-theme.css`, add panel chrome overrides:
    ```css
    /* ---------- Happy Panel Chrome ---------- */
    [data-variant="happy"] .panel,
    [data-variant="happy"] .panel-container,
    [data-variant="happy"] [class*="panel"] {
      border-radius: 14px;
      overflow: hidden; /* clip content to rounded corners */
    }

    [data-variant="happy"] .panel-header {
      border-radius: 14px 14px 0 0;
    }

    /* Subtle shadow elevation — panels float on cream background */
    [data-variant="happy"] .panel {
      box-shadow: 0 1px 3px rgba(80, 70, 50, 0.06), 0 1px 2px rgba(80, 70, 50, 0.04);
    }

    [data-variant="happy"][data-theme="dark"] .panel {
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.20), 0 1px 2px rgba(0, 0, 0, 0.12);
    }
    ```

    **IMPORTANT:** First, read `src/styles/panels.css` to identify the exact class names used for panels, panel headers, panel bodies, empty states, and loading states. The selectors above are estimates — use the actual class names from the file.

    **2. Empty states** — The locked decision requires "soft illustration + message" with nature-themed line illustrations and friendly text like "Coming soon".

    Add CSS for empty panel states in `src/styles/happy-theme.css`:
    ```css
    /* Happy empty state */
    [data-variant="happy"] .panel-empty,
    [data-variant="happy"] .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 24px;
      text-align: center;
      color: var(--text-dim);
      gap: 12px;
    }

    [data-variant="happy"] .panel-empty::before,
    [data-variant="happy"] .empty-state::before {
      content: '';
      display: block;
      width: 48px;
      height: 48px;
      /* Simple nature-themed SVG leaf/sprout icon as CSS background */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' fill='none'%3E%3Cpath d='M24 40V24M24 24C20 20 14 18 8 20C14 14 20 14 24 18C28 14 34 14 40 20C34 18 28 20 24 24Z' stroke='%236B8F5E' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      opacity: 0.6;
    }
    ```

    If the existing codebase has specific empty state classes (check panels.css), target those exact selectors. If panels render empty states with specific HTML structure, match that.

    **3. Loading states** — The existing WorldMonitor may have a radar sweep animation. For the happy variant, use a gentle pulse or shimmer instead:
    ```css
    /* Happy loading animation — gentle sage pulse instead of radar sweep */
    [data-variant="happy"] .loading-indicator,
    [data-variant="happy"] .panel-loading {
      /* Override any radar/military loading animation */
    }

    [data-variant="happy"] .loading-dot,
    [data-variant="happy"] .status-dot.live {
      background: var(--status-live);
      animation: happy-pulse 2s ease-in-out infinite;
    }

    @keyframes happy-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }
    ```

    **4. Audit panels.css for hardcoded colors** — Check `src/styles/panels.css` for any hardcoded color values (e.g., `#ff4444`, `rgba(255, 50, 50, ...)`) in panel headers, status indicators, or error states. For the happy variant, these should be overridden with the semantic color vars. Add targeted overrides in happy-theme.css for any hardcoded colors found in the most visible elements (panel headers, status badges, loading indicators).

    **5. Map container chrome** — If the map has a specific container/toolbar that uses hardcoded dark colors, add overrides:
    ```css
    [data-variant="happy"] .map-toolbar,
    [data-variant="happy"] .map-controls {
      background: var(--surface);
      border-color: var(--border);
      border-radius: 10px;
    }
    ```

    Again, read panels.css and main.css first to identify the actual class names and any hardcoded values.
  </action>
  <verify>
    Run `grep -c 'data-variant.*happy' src/styles/happy-theme.css` to confirm panel chrome overrides were added.
    Run `npm run dev:happy` and inspect panels in DevTools — confirm rounded corners (14px), subtle shadows, and warm colors.
    Check an empty panel shows the sprout illustration and friendly text.
  </verify>
  <done>
    - Panels have 14px rounded corners on the happy variant
    - Panels have subtle warm shadow elevation
    - Empty states show a nature-themed sprout icon with friendly "Coming soon" message
    - Loading indicators use gentle sage pulse instead of military radar sweep
    - No hardcoded dark/military colors bleed through on panel headers or status indicators
    - Map container chrome matches warm theme
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete happy variant shell</name>
  <files>index.html</files>
  <action>
    Visual verification checkpoint. Claude has automated the complete happy variant shell. The user must verify the visual result matches the calm/serene aesthetic direction.

    What was built:
    - Warm cream/sage/gold color palette (light mode)
    - Warm navy/sage dark mode
    - Nunito rounded sans-serif typography
    - Sage landmass + light blue ocean basemap
    - Rounded panel corners with subtle shadows
    - Positive semantic colors (no red/orange threat colors)
    - Nature-themed empty state illustrations
    - Warm skeleton loading shell
    - Correct "Happy Monitor" branding/title
  </action>
  <verify>
    1. Run `npm run dev:happy` and open http://localhost:5173
    2. **Light mode check:**
       - Background should be warm cream (#FAFAF5-ish), not white or gray
       - Map should show sage-green landmass and light blue ocean
       - Panel borders should be rounded (~14px) with subtle shadows
       - Text should be in Nunito font (rounded, friendly sans-serif)
       - Status dot should be sage green
       - No dark/military aesthetic visible anywhere
    3. **Dark mode check** (toggle via theme switch):
       - Background should be deep navy (#1A2332), NOT pure black
       - Map should shift to dark sage land and navy ocean
       - Panels should maintain rounded corners
       - Text remains in Nunito
       - Colors feel warm, not cold/harsh
    4. **Empty panels:** Panels should show a sprout/leaf icon and "Coming soon" text
    5. **Page title:** Browser tab should read "Happy Monitor - Good News & Global Progress"
    6. **Skeleton:** Hard-refresh (Cmd+Shift+R) — brief skeleton should show warm cream, not dark
    7. **No regressions:** Visit http://localhost:5173 WITHOUT dev:happy (normal dev) — original dark theme should be unchanged
  </verify>
  <done>
    User confirms the happy variant visual shell looks calm, serene, and welcoming with no dark/military aesthetic visible. Both light and dark modes feel warm. Typography is rounded and friendly. Map basemap shows sage land and light blue ocean. No regressions to default variant.
  </done>
</task>

</tasks>

<verification>
1. Map renders warm basemap in both light and dark modes
2. Panel chrome has rounded corners, subtle shadows, warm borders
3. Empty states display nature illustration and friendly text
4. Loading indicators pulse gently in sage green
5. No military/threat aesthetic visible on the happy variant
6. Original WorldMonitor variant is unaffected by changes
7. TypeScript compiles clean
</verification>

<success_criteria>
- Both map style JSONs are valid and render correctly in MapLibre GL
- DeckGLMap.ts correctly selects happy styles when variant is 'happy'
- All panel chrome renders with warm rounded aesthetic
- Empty state illustration and message are visible on empty panels
- The complete happy variant shell looks calm, serene, and welcoming
- No regressions to the default WorldMonitor variant
</success_criteria>

<output>
After completion, create `.planning/phases/01-variant-shell-visual-foundation/01-03-SUMMARY.md`
</output>
