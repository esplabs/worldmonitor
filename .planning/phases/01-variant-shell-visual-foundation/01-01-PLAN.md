---
phase: 01-variant-shell-visual-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/variant.ts
  - src/config/variants/happy.ts
  - src/config/panels.ts
  - vite.config.ts
  - package.json
  - index.html
  - public/favico/happy/favicon.svg
  - public/favico/happy/favicon.ico
  - public/favico/happy/favicon-16x16.png
  - public/favico/happy/favicon-32x32.png
  - public/favico/happy/apple-touch-icon.png
  - public/favico/happy/android-chrome-192x192.png
  - public/favico/happy/android-chrome-512x512.png
  - public/favico/happy/og-image.png
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03

user_setup:
  - service: vercel
    why: "Subdomain hosting for happy.worldmonitor.app"
    env_vars:
      - name: VITE_VARIANT
        value: "happy"
        source: "Vercel Dashboard -> Project Settings -> Environment Variables"
    dashboard_config:
      - task: "Add domain happy.worldmonitor.app to Vercel project (or create separate project)"
        location: "Vercel Dashboard -> Project -> Settings -> Domains"

must_haves:
  truths:
    - "Running dev:happy starts the app with VITE_VARIANT=happy and the correct metadata (title, OG tags)"
    - "The happy variant config exports HAPPY_PANELS, HAPPY_MAP_LAYERS, and HAPPY_MOBILE_MAP_LAYERS"
    - "The variant detection in variant.ts recognizes 'happy' as a valid stored variant"
    - "index.html CSP frame-src includes happy.worldmonitor.app"
    - "Favicon files exist for the happy variant in public/favico/happy/"
    - "The inline skeleton script in index.html detects happy variant from hostname and sets data-variant attribute"
  artifacts:
    - path: "src/config/variants/happy.ts"
      provides: "Happy variant panels, map layers, feeds, and VariantConfig"
      contains: "VARIANT_CONFIG"
    - path: "vite.config.ts"
      provides: "Happy variant metadata for build-time HTML injection"
      contains: "happy:"
    - path: "public/favico/happy/favicon.svg"
      provides: "SVG source for happy variant favicon (sage/gold globe)"
  key_links:
    - from: "src/config/variant.ts"
      to: "src/config/panels.ts"
      via: "SITE_VARIANT constant"
      pattern: "stored === 'happy'"
    - from: "src/config/panels.ts"
      to: "src/config/variants/happy.ts"
      via: "ternary chain import"
      pattern: "SITE_VARIANT === 'happy'"
    - from: "vite.config.ts"
      to: "index.html"
      via: "htmlVariantPlugin transformIndexHtml"
      pattern: "VARIANT_META.*happy"
---

<objective>
Register the happy variant in the existing multi-variant architecture, configure build-time metadata injection, prepare subdomain routing, and create favicon assets.

Purpose: Establish the foundational infrastructure so that `VITE_VARIANT=happy` produces a fully-recognized variant with correct branding, metadata, and panel definitions. All subsequent theme/visual plans depend on this variant being registered.

Output: Happy variant config file, updated variant detection, build scripts, VARIANT_META entry, favicon assets, and CSP/skeleton updates in index.html.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-variant-shell-visual-foundation/01-CONTEXT.md
@.planning/phases/01-variant-shell-visual-foundation/01-RESEARCH.md
@src/config/variant.ts
@src/config/panels.ts
@src/config/variants/base.ts
@src/config/variants/tech.ts
@src/config/variants/full.ts
@vite.config.ts
@package.json
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register happy variant in config system and build tooling</name>
  <files>
    src/config/variant.ts
    src/config/variants/happy.ts
    src/config/panels.ts
    vite.config.ts
    package.json
  </files>
  <action>
    **1. src/config/variant.ts** — Add `'happy'` to the allowed stored values:
    ```typescript
    if (stored === 'tech' || stored === 'full' || stored === 'finance' || stored === 'happy') return stored;
    ```

    **2. src/config/variants/happy.ts** — Create new file following the tech.ts/full.ts pattern:
    - Import `PanelConfig`, `MapLayers` from `@/types` and `VariantConfig` from `./base`
    - Re-export `* from './base'`
    - Define a minimal `FEEDS` object with empty categories for now (feeds come in Phase 2). Include a placeholder `positive: []` category.
    - Define `DEFAULT_PANELS` — minimal panel set for Phase 1 shell:
      - `map: { name: 'World Map', enabled: true, priority: 1 }`
      - `'live-news': { name: 'Good News', enabled: true, priority: 1 }` (will show empty state)
      - `progress: { name: 'Human Progress', enabled: true, priority: 1 }` (empty state)
      - `counters: { name: 'Live Counters', enabled: true, priority: 1 }` (empty state)
      - `spotlight: { name: 'Today\'s Hero', enabled: true, priority: 1 }` (empty state)
      - `breakthroughs: { name: 'Breakthroughs', enabled: true, priority: 1 }` (empty state)
    - Define `DEFAULT_MAP_LAYERS: MapLayers` — all layers set to `false` (no geopolitical overlays). Only `natural: true` for positive event dots later.
    - Define `MOBILE_DEFAULT_MAP_LAYERS: MapLayers` — same as above, all false, `natural: true`.
    - Export `VARIANT_CONFIG: VariantConfig` with name `'happy'`, description `'Good news and global progress dashboard'`, and the three config objects.

    **3. src/config/panels.ts** — Add happy case to the ternary chains at the bottom of the file:
    - Import `HAPPY_PANELS`, `HAPPY_MAP_LAYERS`, `HAPPY_MOBILE_MAP_LAYERS` from a happy-specific section OR add them inline.
    - Looking at the existing pattern: panels.ts has FULL_PANELS, TECH_PANELS, FINANCE_PANELS defined inline, then the ternary chains. The happy panels are in variants/happy.ts but the ternary chain in panels.ts needs updating.
    - Actually, the pattern is: panels.ts defines all panel configs inline AND the ternary. The variants/ files are a SEPARATE export system. Both exist.
    - Add `HAPPY_PANELS`, `HAPPY_MAP_LAYERS`, `HAPPY_MOBILE_MAP_LAYERS` definitions to panels.ts (matching the inline pattern), OR import them from variants/happy.ts.
    - Simplest: define a minimal `HAPPY_PANELS` Record in panels.ts matching the happy.ts panel set, plus `HAPPY_MAP_LAYERS` and `HAPPY_MOBILE_MAP_LAYERS`.
    - Update the ternary export chains:
      ```typescript
      export const DEFAULT_PANELS = SITE_VARIANT === 'happy' ? HAPPY_PANELS
        : SITE_VARIANT === 'tech' ? TECH_PANELS
        : SITE_VARIANT === 'finance' ? FINANCE_PANELS
        : FULL_PANELS;
      ```
    - Same for `DEFAULT_MAP_LAYERS` and `MOBILE_DEFAULT_MAP_LAYERS`.

    **4. vite.config.ts** — Add `happy` entry to `VARIANT_META`:
    ```typescript
    happy: {
      title: 'Happy Monitor - Good News & Global Progress',
      description: 'Curated positive news, progress data, and uplifting stories from around the world.',
      keywords: 'good news, positive news, global progress, happy news, uplifting stories, human achievement, science breakthroughs, conservation wins',
      url: 'https://happy.worldmonitor.app/',
      siteName: 'Happy Monitor',
      shortName: 'HappyMonitor',
      subject: 'Good News, Global Progress, and Human Achievement',
      classification: 'Positive News Dashboard, Progress Tracker',
      categories: ['news', 'lifestyle'],
      features: [
        'Curated positive news',
        'Global progress tracking',
        'Live humanity counters',
        'Science breakthrough feed',
        'Conservation tracker',
        'Renewable energy dashboard',
      ],
    },
    ```

    **5. package.json** — Add scripts (matching existing pattern):
    ```json
    "dev:happy": "VITE_VARIANT=happy vite",
    "build:happy": "VITE_VARIANT=happy tsc && VITE_VARIANT=happy vite build",
    ```
    Place them after the existing `dev:finance` / `build:finance` lines.
  </action>
  <verify>
    Run `npm run dev:happy -- --host 2>&1 | head -20` to confirm the dev server starts with happy variant.
    Run `grep -c 'happy' src/config/variant.ts src/config/panels.ts vite.config.ts package.json` to confirm all files reference happy.
    Run `npx tsc --noEmit 2>&1 | head -20` to confirm no TypeScript errors.
  </verify>
  <done>
    - `src/config/variant.ts` recognizes `'happy'` as a valid stored variant
    - `src/config/variants/happy.ts` exports VARIANT_CONFIG, DEFAULT_PANELS, DEFAULT_MAP_LAYERS, MOBILE_DEFAULT_MAP_LAYERS
    - `src/config/panels.ts` ternary chains include happy variant first
    - `vite.config.ts` VARIANT_META includes happy entry
    - `package.json` has `dev:happy` and `build:happy` scripts
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.html for variant detection, CSP, and Google Fonts preconnect</name>
  <files>
    index.html
  </files>
  <action>
    **1. CSP update** — In the `Content-Security-Policy` meta tag, add `happy.worldmonitor.app` to the `frame-src` directive alongside the existing entries. Also add `https://fonts.googleapis.com` and `https://fonts.gstatic.com` to `style-src` and `font-src` respectively (they may already be covered by `https:` in font-src).

    **2. Inline variant detection script** — Update the existing inline `<script>` tag (line 95) that handles theme detection to also detect the variant from hostname OR localStorage:
    ```javascript
    (function(){
      try{
        var t=localStorage.getItem('worldmonitor-theme');
        if(t==='light')document.documentElement.dataset.theme='light';
        // Variant detection
        var v=localStorage.getItem('worldmonitor-variant');
        if(!v){
          var h=location.hostname;
          if(h.startsWith('happy.'))v='happy';
          else if(h.startsWith('tech.'))v='tech';
          else if(h.startsWith('finance.'))v='finance';
        }
        if(v)document.documentElement.dataset.variant=v;
      }catch(e){}
      document.documentElement.classList.add('no-transition');
    })()
    ```
    This sets `data-variant="happy"` on `<html>` before any CSS loads, preventing FOUC for the happy theme.

    **3. Google Fonts preconnect** — Add before the main.css stylesheet link (line 134-135):
    ```html
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    ```
    These can be loaded unconditionally (small overhead for non-happy variants) or conditionally via the Vite htmlVariantPlugin. Simpler: load unconditionally since the CSS only applies font-family when data-variant="happy".

    **4. Favicon variant awareness** — The existing `htmlVariantPlugin` in vite.config.ts replaces meta tags but NOT favicon links. Add favicon path replacement in `htmlVariantPlugin()` for the happy variant:
    - In `vite.config.ts` `htmlVariantPlugin()`, add replacements for favicon paths when `activeVariant === 'happy'`:
      ```
      .replace(/href="\/favico\//g, `href="/favico/${activeVariant === 'full' ? '' : activeVariant + '/'}`)
      ```
    - Actually, simpler approach: add conditional favicon replacements in `transformIndexHtml` only when variant is not 'full':
      ```typescript
      if (activeVariant !== 'full') {
        html = html.replace(/\/favico\/favicon/g, `/favico/${activeVariant}/favicon`)
                   .replace(/\/favico\/apple-touch-icon/g, `/favico/${activeVariant}/apple-touch-icon`)
                   .replace(/\/favico\/og-image/g, `/favico/${activeVariant}/og-image`);
      }
      ```
    - Also update the og:image and twitter:image meta tag URLs to use the variant-specific path.

    Note: Do NOT change the `<meta name="theme-color">` value here — that will be handled in Plan 02 when the theme CSS is defined. For now, the happy variant will inherit the existing theme-color.
  </action>
  <verify>
    Run `grep 'happy.worldmonitor.app' index.html` to confirm CSP update.
    Run `grep 'data.variant' index.html` to confirm variant detection script.
    Run `grep 'fonts.googleapis.com' index.html` to confirm Google Fonts preconnect.
    Run `grep 'favico.*activeVariant\|favico.*happy' vite.config.ts` to confirm favicon variant support.
  </verify>
  <done>
    - index.html CSP frame-src includes happy.worldmonitor.app
    - Inline script detects happy variant from hostname and sets data-variant attribute before paint
    - Google Fonts (Nunito) preconnect and stylesheet links are in the head
    - Favicon paths are variant-aware via htmlVariantPlugin
  </done>
</task>

<task type="auto">
  <name>Task 3: Create happy variant favicon assets</name>
  <files>
    public/favico/happy/favicon.svg
    public/favico/happy/favicon.ico
    public/favico/happy/favicon-16x16.png
    public/favico/happy/favicon-32x32.png
    public/favico/happy/apple-touch-icon.png
    public/favico/happy/android-chrome-192x192.png
    public/favico/happy/android-chrome-512x512.png
    public/favico/happy/og-image.png
  </files>
  <action>
    **1. Create SVG globe favicon** — Design a simple warm-colored globe icon in sage green + gold:
    - Create `public/favico/happy/favicon.svg` with a simple globe design:
      - Circle background in sage green (#6B8F5E)
      - Globe outline/meridians in warm gold (#C4A35A)
      - Simple, clean, recognizable at 16x16
    - The SVG should be a standalone icon that reads as "globe" at small sizes.

    **2. Generate PNG favicons from SVG** — Use a Node.js script with the `sharp` package (or canvas) to generate all required sizes from the SVG. If sharp is not available, use `npx sharp-cli` or write a simple generation script.

    Alternatively, since this is a one-time generation and the project may not have sharp:
    - Create the SVG file first
    - Use `npx @aspect-ratio/svg2png` or write an inline Node.js script with the `canvas` package
    - If no image tools are available: create the SVG and use it as the primary favicon (`<link rel="icon" type="image/svg+xml">`), and create placeholder PNGs by writing minimal valid PNG files or copying and tinting the existing ones.

    **Pragmatic approach**: Create the SVG favicon. For the PNG files, write a small Node.js script that uses the `canvas` npm package (or check if `sharp` is available) to render the SVG at all required sizes. If neither is available, create simple canvas-drawn PNG favicons programmatically with sage/gold colors matching the SVG design.

    Required output files:
    - `favicon.svg` — source SVG (also used directly as favicon in modern browsers)
    - `favicon-16x16.png` — 16x16
    - `favicon-32x32.png` — 32x32
    - `apple-touch-icon.png` — 180x180
    - `android-chrome-192x192.png` — 192x192
    - `android-chrome-512x512.png` — 512x512
    - `favicon.ico` — multi-size ICO (16+32, or just copy the 32x32 as .ico)
    - `og-image.png` — 1200x630, branded card with sage/gold scheme, "Happy Monitor" text, globe icon

    **3. OG image** — Create a simple branded OG image (1200x630) using canvas:
    - Cream background (#FAFAF5)
    - "Happy Monitor" text in sage green, centered
    - Subtitle "Good News & Global Progress" in warm gold
    - Simple globe icon or decorative element
    - Clean, minimal design matching the calm/serene aesthetic
  </action>
  <verify>
    Run `ls -la public/favico/happy/` to confirm all 8 files exist.
    Run `file public/favico/happy/favicon-32x32.png` to confirm valid PNG format.
    Run `file public/favico/happy/og-image.png` to confirm valid PNG format.
  </verify>
  <done>
    - All 8 favicon files exist in public/favico/happy/
    - SVG favicon is a warm-colored globe in sage/gold
    - PNG files are valid images at correct sizes
    - OG image is a branded 1200x630 card with Happy Monitor branding
  </done>
</task>

</tasks>

<verification>
1. `npm run dev:happy` starts successfully and serves the app
2. Browser at localhost shows "Happy Monitor" as the page title (via htmlVariantPlugin)
3. `document.documentElement.dataset.variant` is set to 'happy' when running on happy hostname
4. TypeScript compiles clean: `npx tsc --noEmit` exits 0
5. All favicon files exist and are valid images
</verification>

<success_criteria>
- Happy variant is recognized by all config switch points (variant.ts, panels.ts, vite.config.ts)
- Build scripts `dev:happy` and `build:happy` work correctly
- VARIANT_META drives correct title, description, OG tags for the happy variant
- index.html sets data-variant="happy" before first paint on happy.worldmonitor.app
- Google Fonts (Nunito) preconnect links are in the document head
- Favicon assets exist for the happy variant
</success_criteria>

<output>
After completion, create `.planning/phases/01-variant-shell-visual-foundation/01-01-SUMMARY.md`
</output>
